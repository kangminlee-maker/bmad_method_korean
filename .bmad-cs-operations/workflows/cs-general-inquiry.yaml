workflow:
  id: cs-general-inquiry
  name: 일반 고객 문의 처리
  description: 접수 → 처리 → 품질 리뷰(사람 Sign-off) → 최종 답변의 기본 흐름
  type: cs

  policy_notes:
    - finalize-response 전 반드시 review-response(사람 Sign-off) 수행
    - finalize-response 단계에서 pre-send preview 생성 및 content_hash 저장
    - pre-send preview의 content_hash가 review-response의 Sign-off 기록과 일치해야 발송 가능

  decision_points:
    - id: route_path
      description: 분류 결과와 외부 의존성에 따라 경로를 결정
      branches:
        general: 내부에서 단독 처리 가능
        needs_collaboration: 외부 부서 승인/작업 필요
        handoff_candidate: 완전 이관이 더 적합
    - id: allow_send
      description: 고객 발송 허용 여부 판단
      condition: pre-send preview의 content_hash == review-response Sign-off content_hash
      branches:
        allow_send: 발송 가능
        block_send: 프리뷰 재생성·재승인 필요

  guards:
    - name: required_metadata
      applies_to: [draft-response, review-response, finalize-response, deliver-final-response]
      checks: [case_id, updated_at, author, owner]
    - name: handoff_signoff_required
      applies_to: [assess-handoff-eligibility]
      checks: [reviewer, signed_at]
    - name: human_signoff_required
      applies_to: [review-response, finalize-response, deliver-final-response]
      checks: [reviewer, signed_at, content_hash]

  notes:
    - P1 보존 원칙: 14/15번 규칙에 의해 지정된 P1은 후속 단계에서 임의 강등 금지

  sequence:
    - agent: cs-intake
      action: intake-new-inquiry
    - agent: cs-intake
      action: classify-and-route
    - branch:
        general:
          agent: cs-processor
          action: process-inquiry
        needs_collaboration:
          agent: cs-collaboration-coordinator
          action: delegate-to-department
        handoff_candidate:
          agent: cs-handoff-processor
          action: assess-handoff-eligibility
    - agent: cs-processor
      when: general
      action: draft-response
    - agent: cs-quality
      action: review-response
      notes: 사람 리뷰/Sign-off 필수 (reviewer, signed_at, content_hash 기록)
    - agent: cs-processor
      action: finalize-response
      notes: pre-send preview 생성 및 content_hash 계산·저장, Sign-off와 일치 대조
    - agent: cs-intake
      action: deliver-final-response
      notes: 필요 시 cs-pre-send-checklist로 발송 직전 점검
